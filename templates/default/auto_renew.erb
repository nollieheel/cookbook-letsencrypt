#!/bin/bash

# Generated by Chef

# Try to renew the certificates every ${run_days} days at ${run_time} time.

run_time=<%= @time %>
run_days=<%= @days %>

<% if @email_to -%>
email_to=<%= @email_to %>
email_subj='<%= @email_subject %>'
log_path=<%= @log_path %>
sendmail_bin=<%= @sendmail_bin %>

<% end -%>
letsencrypt_bin=<%= @source_dir %>/letsencrypt-auto
webserver=<%= @web_service %>

script_dir=<%= @script_dir %>
comm="bash ${script_dir}/$( basename $0 )"

usage() {
    echo "Usage: ${0} [-h | -s]"
}

proceed=run
while getopts ":hs" opt; do
    case "$opt" in
        h) proceed=help ;;
        s) proceed=sched ;;
        *) usage; exit 1 ;;
    esac
done
shift $((OPTIND-1))

if [[ "$proceed" == help ]] ; then

    usage

elif [[ "$proceed" == sched ]] ; then

    # Schedule the next renew attempt, but not if there is
    # already another scheduled job running this same script.
    # 
    # To view the currently running jobs, use command:
    #   # atq
    # To delete a job:
    #   # atrm [job_number]
    qc=$( atq | while read q ; do at -c $( echo "$q" | cut -f1 ); done )
    if ! echo "$qc" | grep "$comm" ; then
        ( cd "$script_dir" && echo "$comm" |
              at -M "$run_time" + "$run_days" days )
    fi

elif [[ "$proceed" == run ]] ; then

    # Script needs to stop currently running webserver to try renewal
    service "$webserver" stop
    sleep 2

    $letsencrypt_bin renew
    res=$?

    service "$webserver" start

    <% if @email_to -%>
    if [[ $res -ne 0 ]] ; then
        ERRLOG=$( tail "$log_path" )
        echo -e "Subject: ${email_subj}\nTo: ${email_to}\n\n${ERRLOG}" |
            $sendmail_bin -t
    fi

    <% end -%>
    sleep 1 && $comm -s &

fi
