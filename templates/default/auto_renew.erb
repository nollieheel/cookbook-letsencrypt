#!/bin/bash

# Generated by Chef

# Try to renew the certificates every ${run_days} days at ${run_time} time.

run_time=<%= @time %>
run_days=<%= @days %>

<% if @email_to -%>
email_to=<%= @email_to %>
email_subj='<%= @email_subject %>'
log_path=<%= @log_path %>
sendmail_bin=<%= @sendmail_bin %>

<% end -%>
letsencrypt_bin=<%= @source_dir %>/letsencrypt-auto
<% if @web_service -%>
webserver=<%= @web_service %>
<% end -%>

script_dir=<%= @script_dir %>
comm="bash ${script_dir}/$( basename $0 )"

usage() {
    echo "Usage: ${0} [-h | -s]"
}

proceed=run
while getopts ":hs" opt; do
    case "$opt" in
        h) proceed=help ;;
        s) proceed=sched ;;
        *) usage; exit 1 ;;
    esac
done
shift $((OPTIND-1))

if [[ "$proceed" == help ]] ; then

    usage

elif [[ "$proceed" == sched ]] ; then

    # Schedule the next renew attempt, but not if there is
    # already another scheduled job running this same script.
    # 
    # To view the currently running jobs, use command:
    #   # atq
    # To delete a job:
    #   # atrm [job_number]
    qc=$( atq | while read q ; do at -c $( echo "$q" | cut -f1 ); done )
    if ! echo "$qc" | grep "$comm" ; then
        ( cd "$script_dir" && echo "$comm" |
              at -M "$run_time" + "$run_days" days )
    fi

    echo "Auto-renew set to run in ${run_days} days at ${run_time}."

elif [[ "$proceed" == run ]] ; then

<% @pre_renew_cmds.each do |precmd| -%>
    <%= precmd %>
<% end -%>
<% if @web_service -%>
    echo "Script needs to temporarily stop ${webserver}."
    service "$webserver" stop
    sleep 2
<% end -%>

    echo "Renewing certificates."
    $letsencrypt_bin renew
    res=$?

<% if @web_service -%>
    service "$webserver" start
<% end -%>
<% @post_renew_cmds.each do |postcmd| -%>
    <%= postcmd %>
<% end -%>

<% if @email_to -%>
    if [[ $res -ne 0 ]] ; then
        echo "Error detected. Emailing ${email_to} now."
        ERRLOG=$( tail "$log_path" )
        echo -e "Subject: ${email_subj}\nTo: ${email_to}\n\n${ERRLOG}" |
            $sendmail_bin -t
    fi

<% end -%>
<% unless @s_actions.nil? || @s_actions.length == 0 -%>
    if [[ $res -eq 0 ]] ; then
<%   @s_actions.each do |sact| -%>
        <%= sact %>
<%   end -%>
    fi

<% end -%>
    echo "Automatically scheduling the next auto-renew script run."
    sleep 1 && $comm -s &

fi
